//
//  MetricsHelper.swift
//  CVE-Watch
//
//  Created by Niklas Demel on 14.12.23.
//

import Foundation

struct DisplayMetric: Identifiable {
    let id = UUID()
    var cveID: String?
    var version: String?
    var description: String?
    var vectorString: String?
    var attackVector: String?
    var attackComplexity: String?
    var privilegesRequired: String?
    var userInteraction: String?
    var scope: String?
    var confidentialityImpact: String?
    var integrityImpact: String?
    var availabilityImpact: String?
    var baseScore: Double?
    var baseSeverity: String?
}

enum MetricsVersion: Int,Codable,CaseIterable {
    case MetricsV2 = 1
    case MetricsV30 = 2
    case MetricsV31 = 3
}

class MetricsHelper {
    
    init(){}
    
    func handleMetricsVersion(cves:[Cve]) -> [DisplayMetric] {
        let metrics = UserSettings().metricsVersion
        var display: [DisplayMetric] = []
        for cve in cves {
            
            switch metrics {
            case .MetricsV2:
                if (cve.metrics?.cvssMetricV2 != nil) {
                    display.append(mapMetrics(cve: cve,metrics: metrics))
                    break
                }
            case .MetricsV30:
                if (cve.metrics?.cvssMetricV30 != nil) {
                    display.append(mapMetrics(cve: cve,metrics: metrics))
                    break
                }
            case .MetricsV31:
                if (cve.metrics?.cvssMetricV31 != nil) {
                    display.append(mapMetrics(cve: cve,metrics: metrics))
                    break
                }
            }
        }
        print(display)
        return display
    }
    
    private func mapMetrics(cve: Cve,metrics:MetricsVersion)->DisplayMetric {
        let tmpMetrics = metrics
        var displayMetrics: DisplayMetric
        //TODO: For metrics in metrics and else use other as fallback
        switch tmpMetrics {
        case .MetricsV31:
            let metrics = cve.metrics?.cvssMetricV31![0].cvssData
            displayMetrics = DisplayMetric(cveID: cve.id,
                                           version: metrics!.version,
                                           description: cve.descriptions[0].value,
                                           vectorString: metrics!.vectorString,
                                           attackVector: metrics!.attackVector,
                                           attackComplexity: metrics!.attackComplexity,
                                           privilegesRequired: metrics!.privilegesRequired,
                                           userInteraction: metrics!.userInteraction,
                                           scope: metrics!.scope,
                                           confidentialityImpact: metrics!.confidentialityImpact,
                                           integrityImpact: metrics!.integrityImpact,
                                           availabilityImpact: metrics!.availabilityImpact,
                                           baseScore: metrics!.baseScore,
                                           baseSeverity: metrics!.baseSeverity
            )
            return displayMetrics
        case .MetricsV30:
            let metrics = cve.metrics?.cvssMetricV30![0].cvssData
            displayMetrics = DisplayMetric(cveID: cve.id,
                                           version: metrics!.version,
                                           description: cve.descriptions[0].value,
                                           vectorString: metrics!.vectorString,
                                           attackVector: metrics!.attackVector,
                                           attackComplexity: metrics!.attackComplexity,
                                           privilegesRequired: metrics!.privilegesRequired,
                                           userInteraction: metrics!.userInteraction,
                                           scope: metrics!.scope,
                                           confidentialityImpact: metrics!.confidentialityImpact,
                                           integrityImpact: metrics!.integrityImpact,
                                           availabilityImpact: metrics!.availabilityImpact,
                                           baseScore: metrics!.baseScore,
                                           baseSeverity: metrics!.baseSeverity
            )
            return displayMetrics
        case .MetricsV2:
            let metrics = cve.metrics?.cvssMetricV2![0].cvssData
            let tmp = cve.metrics?.cvssMetricV2![0]
            displayMetrics = DisplayMetric(cveID: cve.id,
                                           version: metrics!.version,
                                           description: cve.descriptions[0].value,
                                           vectorString: metrics!.vectorString,
                                           attackVector: "",
                                           attackComplexity: "",
                                           privilegesRequired: "",
                                           userInteraction: "",
                                           scope: "",
                                           confidentialityImpact: metrics!.confidentialityImpact,
                                           integrityImpact: metrics!.integrityImpact,
                                           availabilityImpact: metrics!.availabilityImpact,
                                           baseScore: metrics!.baseScore,
                                           baseSeverity: tmp?.baseSeverity
            )
            return displayMetrics
            
        }
    }
}

/*func metricsHanlder(Cves: [Cve])->[DisplayMetrics]! {
 //TODO:
 let displayMetrics: [DisplayMetrics]
 for cve in Cves {
 if cve.metrics?.cvssMetricV31 != nil {
 displayMetrics.append(DisplayMetrics(
 cveID: cve.id,
 version: (cve.metrics?.cvssMetricV31?.cvssData.version)!,
 description: <#T##String#>,
 vectorString: <#T##String#>,
 attackVector: <#T##String#>,
 attackComplexity: <#T##String#>,
 privilegesRequired: <#T##String#>,
 userInteraction: <#T##String#>,
 scope: <#T##String#>,
 confidentialityImpact: <#T##String#>,
 integrityImpact: <#T##String#>,
 availabilityImpact: <#T##String#>,
 baseScore: <#T##Double#>,
 baseSeverity: <#T##String#>))
 }
 if cve.metrics?.cvssMetricV30 != nil {
 
 }
 if cve.metrics?.cvssMetricV2 == nil {
 
 }
 }
 return nil
 }*/
