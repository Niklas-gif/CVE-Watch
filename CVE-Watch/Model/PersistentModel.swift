//
//  PersistentModel.swift
//  CVE-Watch
//
//  Created by Niklas Demel on 21.11.23.
//

import Foundation
import Combine

class ModelInterface {
    fileprivate var APPDATA = "appData.json"
    fileprivate var appModelData = AppDatabase.sharedInstance
    fileprivate var appModelObserver = AppObserver.sharedInstance
    
    private func getUserDirectory(dirName: String) ->URL {
        return FileManager.default.urls(for: .documentDirectory, in: .userDomainMask)[0].appendingPathComponent(dirName)
    }
    
    func add(cve: Cve) {
        appModelData.appCves.append(cve)
    }
    
    func save() {
        let url = getUserDirectory(dirName: APPDATA)
        let encodeData = try! JSONEncoder().encode(appModelData.container)
        try! encodeData.write(to: url) // TODO: error handling!
    }
    
    func load() {
        let url = getUserDirectory(dirName: APPDATA)
        if let rawData = try? Data(contentsOf: url)
        {
            appModelData.container = try! JSONDecoder().decode(AppContainer.self, from:rawData)
        }
        
    }
    
    func deleted() {
        appModelData.container.appCves.removeAll()
    }
    
    func getCveData() -> [Cve] {
        return appModelData.appCves
    }
    
}

fileprivate class AppDatabase: ObservableObject {
    static var sharedInstance = AppDatabase()
    fileprivate var container = AppContainer()
    private init() {}
    
    var appCves : [Cve] {
        get {
            return container.appCves
        }
        set (newAppCves)
        {
            container.appCves = newAppCves
        }
    }
}

fileprivate struct AppContainer : Codable {
    private var _appCves : [Cve]?
    var appCves : [Cve] {get {return _appCves ?? []} set {_appCves = newValue}}
}

fileprivate class AppObserver : ObservableObject {
    static var sharedInstance = AppObserver()
    @Published var appModelChanged = false
}
