//
//  SearchVM.swift
//  CVE-Watch
//
//  Created by Niklas Demel on 16.01.24.
//

import Foundation

enum Searchtype {
    case Date
    case CVEid
    case Keyword
}

class SearchVM: ObservableObject {
    private let modelInterface = ModelInterface()
    @Published var isLoading = false
    @Published   var cves: [SearchResult] = []
    
    func update() {
        //cves = modelInterface.getCveData()
    }
    
    
    func fetch(userInput: String,searchtypte: Searchtype) {
        if(userInput != "") {
            isLoading = true
            switch(searchtypte) {
                case .Date: print("Date")
                case .CVEid: fetchByID(userInput: userInput)
                case .Keyword: fetchByDesc(userInput: userInput)
            }
        }
    }
    
    private func fetchByID(userInput: String) {
        Task {
            let fetch = await NetworkClerk().fetchByID(cveID: "CVE-" + userInput)
            DispatchQueue.main.async {
                for vulnerability in fetch?.vulnerabilities ?? [] {
                    self.cves.append(SearchResult(cve: vulnerability.cve))
                    self.update()
                    self.isLoading = false
                }
            }
        }
    }
    
    private func fetchByDesc(userInput: String) {
        Task {
            let fetch = await NetworkClerk().fetchByDescription(description: userInput)
            DispatchQueue.main.async {
                for vulnerability in fetch?.vulnerabilities ?? [] {
                    self.cves.append(SearchResult(cve: vulnerability.cve))
                    //self.storeCve(vulnerability: vulnerability)
                    self.update()
                    self.isLoading = false
                }
            }
            
        }
    }
    
    func toggle(id : UUID) {
        let idx = cves.firstIndex(where: {$0.id == id})!
        cves[idx].isSelected.toggle()
    }
    
    func toggleAll() {
        for cve in cves {
            let idx = cves.firstIndex(where: {$0.id == cve.id})!
            cves[idx].isSelected.toggle()
        }
    }
    
    func storeCves() {
        //TODO: This needs testing!!!
        //TODO: Check if cve alreafy exsists
        for searchResult in cves {
            if(searchResult.isSelected) {
                modelInterface.add(cve: searchResult.cve)
                self.modelInterface.save()
            }
        }
        
    }
    
}
