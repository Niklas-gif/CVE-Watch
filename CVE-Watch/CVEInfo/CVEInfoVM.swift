//
//  CVEInfoVM.swift
//  CVE-Watch
//
//  Created by Niklas Demel on 16.11.23.
//

import Foundation
import Combine
import SwiftUI

class CVEInfoVM: ObservableObject {
    @Published var cves: [Cve] = []
    @Published var displayData: [DisplayMetric] = []
    private let modelInterface = ModelInterface()
    
    fileprivate var subscription: AnyCancellable! = nil
    
   private func handleMetrics() {
        displayData = MetricsHelper().handleMetricsVersion(cves: modelInterface.getCveData())
    }
    
    func update() {
        cves = modelInterface.getCveData()
        handleMetrics()
    }
    
    func getSeverityColor(baseScore: Double)-> Color {
        if (baseScore < 3) {
            return .green
        }
        if (baseScore >= 3 && baseScore < 7) {
            return .orange
        }
        if (baseScore >= 7) {
            return .red
        }
        return .gray
    }
    
    func fetchByID(userInput: String) {
        Task {
            let fetch = await NetworkClerk().fetchByID(cveID: userInput)
            DispatchQueue.main.async {
                for vulnerability in fetch?.vulnerabilities ?? [] {
                    self.storeCve(vulnerability: vulnerability)
                    //TODO: Check if cve alreafy exsists
                    self.modelInterface.save()
                    self.update()
                }
            }
        }
        
        
    }
    
    func autoFetch() {
        Task {
            let fetch = await NetworkClerk().fetchByDate()
            DispatchQueue.main.async {
                for vulnerability in fetch?.vulnerabilities ?? [] {
                    self.storeCve(vulnerability: vulnerability)
                    //TODO: Check if cve alreafy exsists
                    self.modelInterface.save()
                    self.update()
                }
            }
        }
    }
    
   private func storeCve(vulnerability: Vulnerability?) {
        if(vulnerability?.cve != nil) {
            modelInterface.add(cve: vulnerability!.cve)
            cves = modelInterface.getCveData()
            self.update()
        }
    }
    
    func TEST_deleteAll() {
        modelInterface.delete()
        update()
    }
    
    
}
