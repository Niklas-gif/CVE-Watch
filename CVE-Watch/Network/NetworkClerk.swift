//
//  NetworkClerk.swift
//  CVE-Watch
//
//  Created by Niklas Demel on 16.11.23.
//

import Foundation

struct TestRequests {
    let requestByDate = "https://services.nvd.nist.gov/rest/json/cves/2.0?resultsPerPage=20&keywordSearch=MacOs&keywordExactMatch&pubStartDate=2023-10-01T00:00:00.000&pubEndDate=2023-11-16T00:00:00.000"
    let  requestByID = 
        "https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=CVE-2019-14287"
    let getTwenty = "https://services.nvd.nist.gov/rest/json/cves/2.0/?resultsPerPage=20&startIndex=0"
}


class NetworkClerk {
    
    private let CVE_URL = "https://services.nvd.nist.gov/rest/json/cves/2.0?CVEId="
    
    func fetch(api: String) async -> NVDResponse! {
        let request = URLRequest(url: URL(string:CVE_URL + api)!)
        var (data, response): (Data, URLResponse)
        
        do {
            (data, response) = try await URLSession.shared.data(for: request)
        } catch {
            print("request failed")
            return nil
        }
        
        guard(response as? HTTPURLResponse)?.statusCode == 200 else {
            return nil
        }
        let json = convertJSON(data: data)
        return json
    }
    
    private func convertJSON(data: Data) ->NVDResponse! {
        do {
           return try JSONDecoder().decode(NVDResponse.self, from: data)
        } catch {
            print(error)
            return nil
        }
    }
    
    //TODO Build URL
    // Fetch for specific CVE via ID
    // Auto fetch the latest CVES
    
}
